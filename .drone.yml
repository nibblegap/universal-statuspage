kind: pipeline
type: docker
name: linux-amd64

platform:
  os: linux
  arch: amd64

steps:
  - name: build
    image: amd64/node:12.22.1-buster@sha256:436a6432b6f5109c2c70a1f71f5df0e7d29946a967e85882fe08a37f36b8bec4
    commands:
      - npm install
      - npm run build:ssr
  - name: docker
    image: plugins/docker
    settings:
      auto_tag: true
      auto_tag_suffix: linux-amd64
      repo: samuelph/universal-statuspage
      build_args:
        - ARCH=amd64
      username:
        from_secret: USERNAME
      password:
        from_secret: PASSWORD
    when:
      branch:
        - main
      event:
        - push

---
kind: pipeline
type: docker
name: linux-arm64

platform:
  os: linux
  arch: arm64

steps:
  - name: build
    image: arm64v8/node:12.22.1-buster@sha256:beece4c83b620cd54f88d2f16da50c41f62c19a1e8591354ad82726d43d5605a
    commands:
      - npm install
      - npm run build:ssr
  - name: docker
    image: plugins/docker
    settings:
      auto_tag: true
      auto_tag_suffix: linux-arm64
      repo: samuelph/universal-statuspage
      build_args:
        - ARCH=amd64
      username:
        from_secret: USERNAME
      password:
        from_secret: PASSWORD

trigger:
  branch:
    - main
  event:
    - push

# disable temporarily
#---
#kind: pipeline
#type: docker
#name: linux-arm
#
#platform:
#  os: linux
#  arch: arm
#
#steps:
#  - name: build
#    image: arm32v7/node:12.21.0-buster@sha256:e93d480d761345d85d283fba41585c6906c28d1670fa7f9581ead8aadf56e583
#    commands:
#      - npm install
#      - npm run build:ssr
#  - name: docker
#    image: plugins/docker
#    settings:
#      auto_tag: true
#      auto_tag_suffix: linux-arm
#      repo: samuelph/universal-statuspage
#      username:
#        from_secret: USERNAME
#      password:
#        from_secret: PASSWORD
#
#trigger:
#  branch:
#    - main
#  event:
#    - push

---
kind: pipeline
type: docker
name: manifest

steps:
  - name: publish
    image: plugins/manifest
    settings:
      auto_tag: true
      ignore_missing: true
      target: samuelph/universal-statuspage
      template: samuelph/universal-statuspage:OS-ARCH
      platforms:
        - linux/amd64
        - linux/arm64
      #        - linux/arm
      username:
        from_secret: USERNAME
      password:
        from_secret: PASSWORD

depends_on:
  - linux-amd64
  - linux-arm64
#  - linux-arm

trigger:
  branch:
    - main
  event:
    - push
